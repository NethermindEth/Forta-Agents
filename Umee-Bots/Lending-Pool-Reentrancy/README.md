# Detect Reentrancy In Lending Pool

## Description

Detects reentrancy inside LendingProtocol smart contract. If the call is a reentrant call function inside the `reentrancyBlacklist` array.

## Supported Chains

- Ethereum

## Alerts

- UMEE-9
  - Fired when in a transaction occur multiple nested calls to the same contract (reentrancy)
  - Severity is always set to "High"
  - Type is always set to "Exploit"
  - Metadata contains:
    - initialCall: The function that results in a reentrant call. Can also be `"(call)"` or `"(unknown)"` if the selector is, respectively, "0x" or not present in the LendingPool ABI.
    - reentrantCall: The function from the first blacklisted reentrant call that results from the initial call to `initialCallSelector`. Can also be `"(call)"` or `"(unknown)"`, respectively, if the selector is "0x" or not present in the LendingPool ABI.

## Test Data

### Mainnet

Uncomment the lines indicated in `src/agent.config.ts`, use a Kovan testnet trace-enabled RPC endpoint (e.g. `https://eth-mainnet.alchemyapi.io/v2/<Your-Key>`) as `jsonRpcUrl` and `traceRpcUrl` in your `forta.config.json` file and run:

```
npm run tx 0x70e41c3279d8014841665f480f1022569ca3fb840a387baa6b69dd8c74f49675
```

A finding will be emitted because `LendingPool.getReserveNormalizedIncome` is called again from a call that beings in `LendingPool.borrow()`.

### Kovan Testnet (PoC)

The following test was generated by interacting with PoC contracts (available at the `PoC/` directory) deployed on the Kovan testnet.

To check the results, uncomment the lines indicated in `src/agent.config.ts`, use a Kovan testnet trace-enabled RPC endpoint (e.g. `https://eth-kovan.alchemyapi.io/v2/<Your-Key>`) as `jsonRpcUrl` and `traceRpcUrl` in your `forta.config.json` file and run:

```
npm run block 31913146
```

In the block `31913146`, `MockLendingPool.test()` is executed. It will perform a reentrant call to `withdraw()` on `test()` and, because of that, a finding will be emitted with the initial call as `"(unknown)"`, since `test()`, the interaction with `MockLendingPool` that led to the reentrant call, is not part of `LendingPool`'s ABI specification, and with the reentrant call as `"withdraw"`.
